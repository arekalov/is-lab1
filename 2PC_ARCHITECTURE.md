# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–≤—É—Ö—Ñ–∞–∑–Ω–æ–π —Ñ–∏–∫—Å–∞—Ü–∏–∏ (2PC) –¥–ª—è Import Service

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–°—Ç–∞—Ç—É—Å—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π](#—Å—Ç–∞—Ç—É—Å—ã-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
3. [–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π](#–¥–∏–∞–≥—Ä–∞–º–º–∞-–ø–µ—Ä–µ—Ö–æ–¥–æ–≤-—Å–æ—Å—Ç–æ—è–Ω–∏–π)
4. [–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã](#–∫–ª—é—á–µ–≤—ã–µ-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
5. [–ü–æ—Å—Ç—Ä–æ—á–Ω—ã–π —Ä–∞–∑–±–æ—Ä –ª–æ–≥–∏–∫–∏ –∏–º–ø–æ—Ä—Ç–∞](#–ø–æ—Å—Ç—Ä–æ—á–Ω—ã–π-—Ä–∞–∑–±–æ—Ä-–ª–æ–≥–∏–∫–∏-–∏–º–ø–æ—Ä—Ç–∞)
6. [–ü—Ä–æ—Ç–æ–∫–æ–ª 2PC: –∫—Ä–∞—Ç–∫–∞—è —Å—Ö–µ–º–∞](#–ø—Ä–æ—Ç–æ–∫–æ–ª-2pc-–∫—Ä–∞—Ç–∫–∞—è-—Å—Ö–µ–º–∞)
7. [–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä-—Ä–µ–∞–ª—å–Ω–æ–≥–æ-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
8. [–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å](#–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
9. [Recovery –º–µ—Ö–∞–Ω–∏–∑–º](#recovery-–º–µ—Ö–∞–Ω–∏–∑–º)
10. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–∫–ª–∞—Å—Å–æ–≤)
11. [–°—Ü–µ–Ω–∞—Ä–∏–∏ –æ—Ç–∫–∞–∑–æ–≤](#—Å—Ü–µ–Ω–∞—Ä–∏–∏-–æ—Ç–∫–∞–∑–æ–≤)
12. [–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏](#–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞-—ç—Ç–æ–≥–æ-–ø–æ–¥—Ö–æ–¥–∞)
13. [–†–µ–∑—é–º–µ](#—Ä–µ–∑—é–º–µ)

---

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è **—ç–º—É–ª—è—Ü–∏–∏ 2PC** –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É PostgreSQL –∏ MinIO.

**–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è**: –†–∞–∑–¥–µ–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –Ω–∞ 2 —Ñ–∞–∑—ã:
- **Phase 1 (PREPARE)**: –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å, –Ω–æ –ù–ï —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
- **Phase 2 (COMMIT/ABORT)**: –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ò–õ–ò –æ—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

---

## –°—Ç–∞—Ç—É—Å—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### –í—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã

| –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ | –§–∞–∑–∞ 2PC | –§–∏–Ω–∞–ª—å–Ω—ã–π? |
|--------|----------|----------|-----------|
| `PREPARING` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ | Phase 1 | ‚ùå |
| `PREPARED` | –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≥–æ—Ç–æ–≤—ã | Phase 1 | ‚ùå |
| `COMMITTING` | –§–∏–∫—Å–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞—á–∞—Ç–∞ | Phase 2 | ‚ùå |
| `COMMITTED` | –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã | Phase 2 | ‚úÖ |
| `ABORTING` | –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞—á–∞—Ç | Phase 2 | ‚ùå |
| `ABORTED` | –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–∞—á–µ–Ω—ã | Phase 2 | ‚úÖ |

### –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞

#### 1. **PREPARING** (–Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)

**–ö–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:**
- –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ `transaction_log`
- –î–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –≤ MinIO

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
```java
TransactionLog txLog = TransactionLog.builder()
    .transactionId(UUID.randomUUID().toString())
    .state(TransactionState.PREPARING)
    .fileName(fileName)
    .fileSize(fileContent.length)
    .createdAt(LocalDateTime.now())
    .timeoutAt(LocalDateTime.now().plusMinutes(10))
    .build();
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:**
- ‚ùå MinIO staging: —Ñ–∞–π–ª –ù–ï –∑–∞–≥—Ä—É–∂–µ–Ω
- ‚ùå MinIO final: –ø—É—Å—Ç–æ
- ‚ùå –ë–î: –¥–∞–Ω–Ω—ã–µ –ù–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- ‚úÖ transaction_log: –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞

**–°–ª–µ–¥—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å:**
- ‚Üí `PREPARED` (–µ—Å–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞)
- ‚Üí `ABORTED` (–µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –Ω–∞ —ç—Ç–∞–ø–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏)

---

#### 2. **PREPARED** (–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)

**–ö–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:**
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –≤ MinIO staging
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JSON

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
```java
// 1. –ó–∞–≥—Ä—É–∑–∏–ª–∏ —Ñ–∞–π–ª –≤ staging
minioService.uploadToStaging(txId, fileContent);

// 2. –ü—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–ª–∏ JSON
List<ImportOperationRequest> operations = validateJson(json);

// 3. –û–±–Ω–æ–≤–∏–ª–∏ —Å—Ç–∞—Ç—É—Å
txLog.setState(TransactionState.PREPARED);
txLog.setStagingObjectKey("staging/" + txId + ".json");
txLog.setValidatedOperations(json);
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:**
- ‚úÖ MinIO staging: —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω (`staging/{txId}.json`)
- ‚ùå MinIO final: –ø—É—Å—Ç–æ
- ‚ùå –ë–î: –¥–∞–Ω–Ω—ã–µ –ù–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (—Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã)
- ‚úÖ transaction_log: `state=PREPARED`, `staging_object_key` –∑–∞–ø–æ–ª–Ω–µ–Ω

**–°–ª–µ–¥—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å:**
- ‚Üí `COMMITTING` (–µ—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —Ä–µ—à–∏–ª COMMIT)
- ‚Üí `ABORTING` (–µ—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —Ä–µ—à–∏–ª ABORT)

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –º–æ–º–µ–Ω—Ç**: –≠—Ç–æ —Ç–æ—á–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–æ–º!

---

#### 3. **COMMITTING** (—Ñ–∏–∫—Å–∞—Ü–∏—è –Ω–∞—á–∞—Ç–∞)

**–ö–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:**
- –ü–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
- –ü–ï–†–ï–î –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ñ–∞–π–ª–∞ –∏–∑ staging –≤ final

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
```java
// 1. –ù–∞—á–∏–Ω–∞–µ–º —Ñ–∏–∫—Å–∞—Ü–∏—é
txLog.setState(TransactionState.COMMITTING);
txLogRepository.save(txLog);  // ‚ö†Ô∏è –í–∞–∂–Ω–æ: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –î–û –æ–ø–µ—Ä–∞—Ü–∏–π —Å –¥–∞–Ω–Ω—ã–º–∏

// 2. –í—ã–ø–æ–ª–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
for (ImportOperationRequest operation : operations) {
    processFlatOperation(operation.getType(), operation.getData());
}

// 3. –°–æ–∑–¥–∞–µ–º ImportHistory
ImportHistory history = ImportHistory.builder()
    .operationTime(LocalDateTime.now())
    .objectsCount(successCount)
    .build();
history = importHistoryRepository.save(history);

// 4. –°–≤—è–∑—ã–≤–∞–µ–º —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
txLog.setImportHistoryId(history.getId());
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:**
- ‚úÖ MinIO staging: —Ñ–∞–π–ª –µ—Å—Ç—å (`staging/{txId}.json`)
- ‚ùå MinIO final: –ø—É—Å—Ç–æ (–µ—â–µ –Ω–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏!)
- ‚ö†Ô∏è –ë–î: –¥–∞–Ω–Ω—ã–µ –°–û–•–†–ê–ù–ï–ù–´ (Flat, House, Coordinates, ImportHistory)
- ‚úÖ transaction_log: `state=COMMITTING`, `import_history_id` –∑–∞–ø–æ–ª–Ω–µ–Ω

**‚ö†Ô∏è –û–ü–ê–°–ù–ê–Ø –ó–û–ù–ê**: –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —É–ø–∞–¥–µ—Ç –∑–¥–µ—Å—å, —Ç–æ:
- –î–∞–Ω–Ω—ã–µ –≤ –ë–î —É–∂–µ –µ—Å—Ç—å
- –ù–æ —Ñ–∞–π–ª –µ—â–µ –Ω–µ –≤ final/
- Recovery –¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ!

**–°–ª–µ–¥—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å:**
- ‚Üí `COMMITTED` (–ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ final)

---

#### 4. **COMMITTED** (—É—Å–ø–µ—à–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è) ‚úÖ

**–ö–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:**
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–∑ staging –≤ final
- –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–∑ staging

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
```java
// 1. –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª staging ‚Üí final
String finalKey = "final/import-" + timestamp + ".json";
minioService.copyToFinal(stagingKey, finalKey);

// 2. –£–¥–∞–ª—è–µ–º –∏–∑ staging (–æ—á–∏—Å—Ç–∫–∞)
minioService.deleteStaging(stagingKey);

// 3. –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
txLog.setState(TransactionState.COMMITTED);
txLog.setFinalObjectKey(finalKey);
txLog.setUpdatedAt(LocalDateTime.now());
txLogRepository.save(txLog);
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:**
- ‚ùå MinIO staging: —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω
- ‚úÖ MinIO final: —Ñ–∞–π–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (`final/import-...json`)
- ‚úÖ –ë–î: –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- ‚úÖ transaction_log: `state=COMMITTED`, `final_object_key` –∑–∞–ø–æ–ª–Ω–µ–Ω
- ‚úÖ ImportHistory: –∑–∞–ø–∏—Å—å –¥–æ—Å—Ç—É–ø–Ω–∞ —Å `fileObjectKey`

**–≠—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —É—Å–ø–µ—à–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ!** –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. ‚úÖ

---

#### 5. **ABORTING** (–æ—Ç–∫–∞—Ç –Ω–∞—á–∞—Ç)

**–ö–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:**
- –ü—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –ü—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª
- –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
```java
// 1. –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç–∫–∞—Ç
txLog.setState(TransactionState.ABORTING);
txLogRepository.save(txLog);

// 2. –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –∏–∑ staging
if (txLog.getStagingObjectKey() != null) {
    minioService.deleteStaging(txLog.getStagingObjectKey());
}

// 3. –ë–î –æ—Ç–∫–∞—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ @Transactional
// (–≤—Å–µ INSERT/UPDATE/DELETE –æ—Ç–º–µ–Ω—è—Ç—Å—è)

// 4. –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
txLog.setState(TransactionState.ABORTED);
txLog.setUpdatedAt(LocalDateTime.now());
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:**
- ‚ùå MinIO staging: —Ñ–∞–π–ª —É–¥–∞–ª—è–µ—Ç—Å—è
- ‚ùå MinIO final: –ø—É—Å—Ç–æ
- ‚ùå –ë–î: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è (ROLLBACK)
- ‚úÖ transaction_log: `state=ABORTING`

**–°–ª–µ–¥—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å:**
- ‚Üí `ABORTED` (–ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ staging –∏ ROLLBACK –ë–î)

---

#### 6. **ABORTED** (–æ—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω) ‚ùå

**–ö–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:**
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–∑ staging
- –ü–æ—Å–ª–µ –æ—Ç–∫–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
```java
// –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
txLog.setState(TransactionState.ABORTED);
txLog.setUpdatedAt(LocalDateTime.now());
txLogRepository.save(txLog);

// HTTP Response
throw new UniqueConstraintViolationException("...");
// ‚Üí 400 Bad Request –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:**
- ‚ùå MinIO staging: —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω
- ‚ùå MinIO final: –ø—É—Å—Ç–æ
- ‚ùå –ë–î: –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–∞—á–µ–Ω—ã (–∫–∞–∫ –±—É–¥—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –±—ã–ª–æ)
- ‚úÖ transaction_log: `state=ABORTED` (—Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å—å –æ–± –æ—à–∏–±–∫–µ)
- ‚ùå ImportHistory: –∑–∞–ø–∏—Å—å –ù–ï —Å–æ–∑–¥–∞–Ω–∞

**–≠—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—à–∏–±–∫–∏!** –í—Å–µ –æ—Ç–∫–∞—á–µ–Ω–æ. ‚ùå

---

## –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π

### –ì—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π (FSM - Finite State Machine)

```
                    [START]
                       ‚Üì
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ  PREPARING  ‚îÇ ‚Üê –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚Üì                         ‚Üì
    [SUCCESS]                  [ERROR]
          ‚Üì                         ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  PREPARED   ‚îÇ          ‚îÇ  ABORTING   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚Üì                         ‚Üì
    [Coordinator                    ‚Üì
     Decision]              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚Üì                 ‚îÇ   ABORTED   ‚îÇ ‚úÖ FINAL
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ‚Üì             ‚Üì
[COMMIT]      [ABORT]
   ‚Üì             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îî‚îÄ> ABORTING ‚Üí ABORTED
‚îÇ COMMITTING  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
  [Success]
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  COMMITTED  ‚îÇ ‚úÖ FINAL
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Happy Path (—É—Å–ø–µ—à–Ω—ã–π –ø—É—Ç—å)

```
PREPARING ‚Üí PREPARED ‚Üí COMMITTING ‚Üí COMMITTED ‚úÖ
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: ~500ms - 2s

### Error Path (–ø—É—Ç—å —Å –æ—à–∏–±–∫–æ–π)

```
PREPARING ‚Üí PREPARED ‚Üí ABORTING ‚Üí ABORTED ‚ùå
          ‚Üì
         [–∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é]
          ‚Üì
      ABORTING ‚Üí ABORTED ‚ùå
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: ~200ms - 1s (–±—ã—Å—Ç—Ä–µ–µ, —Ç.–∫. –Ω–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ –ë–î)

### –¢–∞–±–ª–∏—Ü–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

| –ò–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è | –í —Å–æ—Å—Ç–æ—è–Ω–∏–µ | –£—Å–ª–æ–≤–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ |
|-------------|------------|---------|----------|
| `PREPARING` | `PREPARED` | ‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –≤ staging + JSON –≤–∞–ª–∏–¥–µ–Ω | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `staging_object_key` |
| `PREPARING` | `ABORTING` | ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ | –ù–∞—á–∞—Ç—å –æ—Ç–∫–∞—Ç |
| `PREPARED` | `COMMITTING` | ‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —Ä–µ—à–∏–ª COMMIT | –ù–∞—á–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î |
| `PREPARED` | `ABORTING` | ‚ùå –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —Ä–µ—à–∏–ª ABORT | –£–¥–∞–ª–∏—Ç—å staging —Ñ–∞–π–ª |
| `COMMITTING` | `COMMITTED` | ‚úÖ –§–∞–π–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω staging ‚Üí final | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `final_object_key` |
| `COMMITTING` | `ABORTING` | ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ | –û—Ç–∫–∞—Ç (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π!) |
| `ABORTING` | `ABORTED` | ‚úÖ Staging –æ—á–∏—â–µ–Ω + ROLLBACK | –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—à–∏–±–∫–∏ |

---

## –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. **–¢–∞–±–ª–∏—Ü–∞ transaction_log** (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)

```sql
CREATE TABLE transaction_log (
    id BIGSERIAL PRIMARY KEY,
    transaction_id VARCHAR(255) UNIQUE NOT NULL,  -- UUID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    state VARCHAR(50) NOT NULL,                   -- PREPARED, COMMITTED, ABORTED
    
    -- MinIO staging file info
    staging_object_key VARCHAR(255),              -- staging/{uuid}.json
    final_object_key VARCHAR(255),                -- final/{uuid}.json
    
    -- Import metadata
    import_history_id BIGINT,                     -- FK to import_history
    file_name VARCHAR(255),
    file_size BIGINT,
    
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    timeout_at TIMESTAMP,                          -- –î–ª—è recovery (5-10 –º–∏–Ω—É—Ç)
    
    CONSTRAINT check_state CHECK (state IN ('PREPARING', 'PREPARED', 'COMMITTING', 'COMMITTED', 'ABORTING', 'ABORTED'))
);
```

### 2. **MinIO —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∫–µ—Ç–æ–≤**

```
import-files/
‚îú‚îÄ‚îÄ staging/          # –§–∞–∑–∞ PREPARE - —Ñ–∞–π–ª—ã –∑–¥–µ—Å—å –ù–ï "–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã"
‚îÇ   ‚îî‚îÄ‚îÄ {uuid}.json   # –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
‚îÇ
‚îî‚îÄ‚îÄ final/            # –§–∞–∑–∞ COMMIT - —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
    ‚îî‚îÄ‚îÄ {uuid}.json   # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞**: –æ–¥–∏–Ω –±–∞–∫–µ—Ç —Å metadata —Ç—ç–≥–∞–º–∏:
- staging —Ñ–∞–π–ª: metadata `status=pending`
- final —Ñ–∞–π–ª: metadata `status=committed`

---

## –ü–æ—Å—Ç—Ä–æ—á–Ω—ã–π —Ä–∞–∑–±–æ—Ä –ª–æ–≥–∏–∫–∏ –∏–º–ø–æ—Ä—Ç–∞

### üìç –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: HTTP Request

```http
POST /api/import
Content-Type: application/json

[{"type": "FLAT", "operation": "CREATE", "data": {...}}]
```

---

### üéØ ImportController ‚Üí ImportService

**–°—Ç—Ä–æ–∫–∞ 73-75** (`ImportService.java`):
```java
public ImportHistory importObjects(String json) {
    return importObjectsWithFileName(json, "import-" + System.currentTimeMillis() + ".json");
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞: `import-1703260728069.json`
- –í—ã–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ `importObjectsWithFileName()`

---

### üöÄ –®–ê–ì 1: BEGIN TRANSACTION

**–°—Ç—Ä–æ–∫–∞ 88-95** (`ImportService.java`):
```java
@Transactional(Transactional.TxType.REQUIRED)  // ‚ö†Ô∏è JTA —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–ª—è –ë–î
public ImportHistory importObjectsWithFileName(String json, String fileName) {
    byte[] fileContent = json.getBytes();
    TransactionLog txLog = null;
    
    try {
        txLog = txCoordinator.beginTransaction(fileContent, fileName);
```

#### TransactionCoordinator.beginTransaction()

**–°—Ç—Ä–æ–∫–∞ 59-62** (`TransactionCoordinator.java`):
```java
@Transactional(Transactional.TxType.REQUIRES_NEW)  // ‚ö†Ô∏è –ù–û–í–ê–Ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è!
public TransactionLog beginTransaction(byte[] fileContent, String fileName) {
    String txId = UUID.randomUUID().toString();
    String fileHash = calculateSHA256(fileContent);
```

**–ü–æ—á–µ–º—É `REQUIRES_NEW`?**
- –°–æ–∑–¥–∞–µ–º –û–¢–î–ï–õ–¨–ù–£–Æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è `transaction_log`
- –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∏—Ç—Å—è, –∑–∞–ø–∏—Å—å –æ—Å—Ç–∞–µ—Ç—Å—è (–∞—É–¥–∏—Ç)

**–°—Ç—Ä–æ–∫–∞ 72-85** ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏:
```java
Optional<TransactionLog> existing = txLogRepository.findByFileHashAndState(
    fileHash, TransactionState.COMMITTED
);

if (existing.isPresent()) {
    logger.warning("‚ïë  IDEMPOTENCY: File already imported!                   ‚ïë");
    return existing.get();  // ‚ö†Ô∏è EARLY RETURN!
}
```

**SQL –∑–∞–ø—Ä–æ—Å:**
```sql
SELECT * FROM transaction_log 
WHERE file_hash = '7a3b2f9c...' AND state = 'COMMITTED';
```

**–°—Ç—Ä–æ–∫–∞ 87-98** ‚Äî –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏:
```java
TransactionLog txLog = TransactionLog.builder()
    .transactionId(txId)
    .state(TransactionState.PREPARING)  // ‚Üê –ù–ê–ß–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
    .fileName(fileName)
    .fileSize((long) fileContent.length)
    .fileHash(fileHash)
    .timeoutAt(LocalDateTime.now().plusMinutes(10))
    .build();

txLog = txLogRepository.save(txLog);
```

**SQL –∑–∞–ø—Ä–æ—Å:**
```sql
INSERT INTO transaction_log (
    transaction_id, state, file_name, file_size, file_hash, 
    created_at, timeout_at
) VALUES (
    'a3f7b2c9-...', 'PREPARING', 'import-...json', 458, 
    '7a3b2f9c...', NOW(), NOW() + INTERVAL '10 minutes'
);
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚úÖ `transaction_log`: `state=PREPARING`
- ‚ùå MinIO staging: –ø—É—Å—Ç–æ
- ‚ùå –ë–î (flats/houses): –ø—É—Å—Ç–æ

---

### üìç –®–ê–ì 2: PHASE 1 - PREPARE MinIO

**–°—Ç—Ä–æ–∫–∞ 104-105** (`ImportService.java`):
```java
txLog = txCoordinator.prepareMinIO(txLog, fileContent);
```

#### TransactionCoordinator.prepareMinIO()

**–°—Ç—Ä–æ–∫–∞ 117-123** (`TransactionCoordinator.java`):
```java
String stagingKey = minioService.uploadToStaging(
    fileContent, 
    txLog.getTransactionId(),
    txLog.getFileName()
);
```

**MinIO –æ–ø–µ—Ä–∞—Ü–∏—è:**
```
PUT import-files/staging/a3f7b2c9-....json
Content: [{"type":"FLAT",...}]
```

**–°—Ç—Ä–æ–∫–∞ 125-127** ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ txLog:
```java
txLog.setStagingObjectKey(stagingKey);
txLog = txLogRepository.save(txLog);
```

**SQL –∑–∞–ø—Ä–æ—Å:**
```sql
UPDATE transaction_log 
SET staging_object_key = 'staging/a3f7b2c9-...json',
    updated_at = NOW()
WHERE id = 85;
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —à–∞–≥–∞:**
- ‚úÖ MinIO staging: `staging/a3f7b2c9-...json`
- ‚úÖ `transaction_log`: `staging_object_key` –∑–∞–ø–æ–ª–Ω–µ–Ω
- ‚ùå MinIO final: –ø—É—Å—Ç–æ
- ‚ùå –ë–î (flats/houses): –ø—É—Å—Ç–æ

---

### üìç –®–ê–ì 3: PHASE 1 - PREPARE Database

**–°—Ç—Ä–æ–∫–∞ 107-108** (`ImportService.java`):
```java
txLog = txCoordinator.prepareDatabase(txLog, json);
```

#### TransactionCoordinator.prepareDatabase()

**–°—Ç—Ä–æ–∫–∞ 171-175** (`TransactionCoordinator.java`):
```java
if (operationsJson == null || operationsJson.trim().isEmpty()) {
    throw new IllegalArgumentException("Operations JSON is empty");
}
```

**–°—Ç—Ä–æ–∫–∞ 185-188** ‚Äî –°–æ—Ö—Ä–∞–Ω—è–µ–º JSON:
```java
txLog.setValidatedOperations(operationsJson);
txLog.setState(TransactionState.PREPARED);  // ‚Üê –û–ë–ê —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≥–æ—Ç–æ–≤—ã!
txLog = txLogRepository.save(txLog);
```

**SQL –∑–∞–ø—Ä–æ—Å:**
```sql
UPDATE transaction_log 
SET validated_operations = '[{"type":"FLAT",...}]',
    state = 'PREPARED',         -- ‚Üê –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–ï–†–ï–•–û–î!
    updated_at = NOW()
WHERE id = 85;
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚úÖ MinIO staging: —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω
- ‚úÖ `transaction_log`: `state=PREPARED` (–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!)
- ‚úÖ `validated_operations`: JSON —Å–æ—Ö—Ä–∞–Ω–µ–Ω
- ‚ùå –ë–î (flats/houses): –Ω–∏—á–µ–≥–æ (–µ—â–µ –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–ª–∏!)

---

### üéØ –ö–û–û–†–î–ò–ù–ê–¢–û–†: –†–µ—à–µ–Ω–∏–µ COMMIT

**–°—Ç—Ä–æ–∫–∞ 110-115** (`ImportService.java`):
```java
List<ImportOperationRequest> operations = objectMapper.readValue(
    txLog.getValidatedOperations(),  // ‚Üê –ß–∏—Ç–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π JSON
    objectMapper.getTypeFactory().constructCollectionType(...)
);

logger.info("‚ïë  PHASE 2: COMMIT Database Participant                   ‚ïë");
```

---

### üî® –®–ê–ì 4: PHASE 2 - COMMIT Database

**–°—Ç—Ä–æ–∫–∞ 121-151** ‚Äî –¶–∏–∫–ª –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º:
```java
int successCount = 0;
for (int i = 0; i < operations.size(); i++) {
    ImportOperationRequest operation = operations.get(i);
    
    int affectedObjects = 0;
    switch (type) {
        case "FLAT":
            affectedObjects = processFlatOperation(op, dataNode);  // ‚Üê –°–û–ó–î–ê–ï–ú!
            break;
        // ...
    }
    successCount += affectedObjects;
}
```

#### –í–Ω—É—Ç—Ä–∏ processFlatOperation() ‚Üí createFlat():

```java
private int createFlat(JsonNode dataNode) {
    int createdObjects = 0;
    
    // 1. –°–æ–∑–¥–∞–µ–º Coordinates
    coords = flatRepository.saveCoordinates(coords);  // INSERT INTO coordinates
    createdObjects++;
    
    // 2. –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º House
    if (houseNode.isNumber()) {
        house = houseRepository.findById(houseId);
    } else {
        house = houseRepository.save(house);  // INSERT INTO houses
        createdObjects++;
    }
    
    // 3. –í–∞–ª–∏–¥–∏—Ä—É–µ–º —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π!
    flatService.validateTerribleViewConstraint(flat);
    flatService.validateCoordinatesAndFloorUniqueness(flat);  // ‚Üê PESSIMISTIC LOCK!
    
    // 4. –°–æ–∑–¥–∞–µ–º Flat
    flat = flatRepository.save(flat);  // INSERT INTO flats
    createdObjects++;
    
    return createdObjects;  // 3 (Coordinates + House + Flat)
}
```

**SQL –∑–∞–ø—Ä–æ—Å—ã:**
```sql
-- 1. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
INSERT INTO coordinates (x, y) VALUES (100, 200);  -- id=150

-- 2. –î–æ–º
INSERT INTO houses (name, year, number_of_flats_on_floor) 
VALUES ('–î–æ–º –Ω–∞ –ù–µ–≤—Å–∫–æ–º', 2020, 4);  -- id=100

-- 3. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ–º–∞
SELECT * FROM houses WHERE id = 100 FOR UPDATE;  -- üîí LOCK

-- 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
SELECT COUNT(*) FROM flats f 
JOIN coordinates c ON f.coordinates_id = c.id
WHERE c.x = 100 AND c.y = 200 AND f.floor = 1;

-- 5. –ö–≤–∞—Ä—Ç–∏—Ä–∞
INSERT INTO flats (name, floor, area, coordinates_id, house_id, ...) 
VALUES ('–ö–≤–∞—Ä—Ç–∏—Ä–∞ 101', 1, 50, 150, 100, ...);  -- id=201
```

**–°—Ç—Ä–æ–∫–∞ 153-160** ‚Äî –°–æ–∑–¥–∞–Ω–∏–µ ImportHistory:
```java
ImportHistory history = ImportHistory.builder()
    .operationTime(LocalDateTime.now())
    .objectsCount(successCount)  // 3
    .build();

history = importHistoryRepository.save(history);
```

**SQL –∑–∞–ø—Ä–æ—Å:**
```sql
INSERT INTO import_history (operation_time, objects_count, created_at) 
VALUES (NOW(), 3, NOW());  -- id=123
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚úÖ MinIO staging: —Ñ–∞–π–ª –µ—Å—Ç—å
- ‚úÖ –ë–î: Coordinates, House, Flat, ImportHistory –°–û–ó–î–ê–ù–´!
- ‚ö†Ô∏è –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ë–î –µ—â–µ –ù–ï –ó–ê–ö–û–ú–ú–ò–ß–ï–ù–ê
- ‚ùå MinIO final: –ø—É—Å—Ç–æ

---

### üöÄ –®–ê–ì 5: PHASE 2 - COMMIT MinIO

**–°—Ç—Ä–æ–∫–∞ 162-163** (`ImportService.java`):
```java
txLog = txCoordinator.commit(txLog, history);
```

#### TransactionCoordinator.commit()

**–°—Ç—Ä–æ–∫–∞ 233-239** (`TransactionCoordinator.java`):
```java
txLog.setState(TransactionState.COMMITTING);
txLog.setImportHistoryId(importHistory.getId());
txLog = txLogRepository.save(txLog);
```

**SQL –∑–∞–ø—Ä–æ—Å:**
```sql
UPDATE transaction_log 
SET state = 'COMMITTING',          -- ‚Üê –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–ï–†–ï–•–û–î!
    import_history_id = 123,
    updated_at = NOW()
WHERE id = 85;
```

‚ö†Ô∏è **–û–ü–ê–°–ù–ê–Ø –ó–û–ù–ê:** –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —É–ø–∞–¥–µ—Ç –∑–¥–µ—Å—å, –¥–∞–Ω–Ω—ã–µ –≤ –ë–î –µ—Å—Ç—å, –Ω–æ —Ñ–∞–π–ª –Ω–µ –≤ final!

**–°—Ç—Ä–æ–∫–∞ 241-246** ‚Äî –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞:
```java
String finalKey = minioService.copyToFinal(
    txLog.getStagingObjectKey(),
    txLog.getTransactionId()
);
```

**MinIO –æ–ø–µ—Ä–∞—Ü–∏–∏:**
```
COPY import-files/staging/a3f7b2c9-...json 
  TO import-files/final/import-2025-12-22-...json
```

**–°—Ç—Ä–æ–∫–∞ 248-250** ‚Äî –£–¥–∞–ª–µ–Ω–∏–µ staging:
```java
minioService.deleteStaging(txLog.getStagingObjectKey());
```

**MinIO –æ–ø–µ—Ä–∞—Ü–∏—è:**
```
DELETE import-files/staging/a3f7b2c9-...json
```

**–°—Ç—Ä–æ–∫–∞ 252-255** ‚Äî –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å:
```java
txLog.setFinalObjectKey(finalKey);
txLog.setState(TransactionState.COMMITTED);  // ‚Üê –£–°–ü–ï–•!
txLog = txLogRepository.save(txLog);
```

**SQL –∑–∞–ø—Ä–æ—Å:**
```sql
UPDATE transaction_log 
SET state = 'COMMITTED',
    final_object_key = 'final/import-2025-12-22-...json',
    updated_at = NOW()
WHERE id = 85;
```

---

### üîó –®–ê–ì 6: –°–≤—è–∑—ã–≤–∞–Ω–∏–µ ImportHistory —Å —Ñ–∞–π–ª–æ–º

**–°—Ç—Ä–æ–∫–∞ 165-167** (`ImportService.java`):
```java
history.setFileObjectKey(txLog.getFinalObjectKey());
history = importHistoryRepository.save(history);
```

**SQL –∑–∞–ø—Ä–æ—Å:**
```sql
UPDATE import_history 
SET file_object_key = 'final/import-2025-12-22-...json'
WHERE id = 123;
```

---

### ‚úÖ –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–°—Ç—Ä–æ–∫–∞ 169**:
```java
return history;
```

**HTTP Response:**
```json
{
  "id": 123,
  "operationTime": "2025-12-22T12:38:48",
  "objectsCount": 3,
  "fileObjectKey": "final/import-2025-12-22-12-38-48-069.json"
}
```

**–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**

| –†–µ—Å—É—Ä—Å | –°–æ—Å—Ç–æ—è–Ω–∏–µ |
|--------|-----------|
| **PostgreSQL** | Coordinates (150), House (100), Flat (201), ImportHistory (123) ‚úÖ |
| **MinIO staging/** | –ü—É—Å—Ç–æ (—É–¥–∞–ª–µ–Ω) |
| **MinIO final/** | `import-2025-12-22-...json` ‚úÖ |
| **transaction_log** | `state=COMMITTED` ‚úÖ |

---

### ‚ùå –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö

**–°—Ç—Ä–æ–∫–∞ 171-184** (`ImportService.java`):
```java
} catch (ValidationException e) {
    abortTransaction(txLog);
    throw e;
    
} catch (UniqueConstraintViolationException e) {
    abortTransaction(txLog);
    throw e;
```

#### TransactionCoordinator.abort()

**–°—Ç—Ä–æ–∫–∞ 292-299** (`TransactionCoordinator.java`):
```java
txLog.setState(TransactionState.ABORTING);
txLog = txLogRepository.save(txLog);

if (txLog.getStagingObjectKey() != null) {
    minioService.deleteStaging(txLog.getStagingObjectKey());
}
```

**MinIO –æ–ø–µ—Ä–∞—Ü–∏—è:**
```
DELETE import-files/staging/a3f7b2c9-...json
```

**–°—Ç—Ä–æ–∫–∞ 304-305**:
```java
txLog.setState(TransactionState.ABORTED);
txLogRepository.save(txLog);
```

**SQL –∑–∞–ø—Ä–æ—Å:**
```sql
ROLLBACK;  -- –í—Å–µ INSERT –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è!

UPDATE transaction_log 
SET state = 'ABORTED', updated_at = NOW()
WHERE id = 85;
```

**–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ:**
- ‚ùå PostgreSQL: –í—Å–µ –æ—Ç–∫–∞—á–µ–Ω–æ (ROLLBACK)
- ‚ùå MinIO staging: –ü—É—Å—Ç–æ (—É–¥–∞–ª–µ–Ω)
- ‚ùå MinIO final: –ü—É—Å—Ç–æ
- ‚úÖ transaction_log: `state=ABORTED` (–∞—É–¥–∏—Ç)

**HTTP Response:** `400 Bad Request`

---

### üìä –ò—Ç–æ–≥–æ–≤–∞—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è

```
t0:  HTTP POST /api/import
t1:  BEGIN TRANSACTION (state=PREPARING)
     ‚Üí INSERT INTO transaction_log
t2:  PREPARE MinIO (upload to staging/)
     ‚Üí PUT staging/a3f7b2c9-...json
t3:  PREPARE Database (validate JSON, state=PREPARED)
     ‚Üí UPDATE transaction_log SET validated_operations
t4:  PHASE 2: COMMIT Database
     ‚Üí INSERT INTO coordinates, houses, flats
t5:  CREATE ImportHistory
     ‚Üí INSERT INTO import_history
t6:  UPDATE transaction_log (state=COMMITTING)
t7:  PHASE 2: COMMIT MinIO
     ‚Üí COPY staging ‚Üí final
t8:  DELETE staging file
t9:  UPDATE transaction_log (state=COMMITTED)
t10: UPDATE import_history (file_object_key)
t11: HTTP 200 OK
```

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** ~800-1200ms

---

## –ü—Ä–æ—Ç–æ–∫–æ–ª 2PC: –∫—Ä–∞—Ç–∫–∞—è —Å—Ö–µ–º–∞

### PHASE 1: PREPARE (–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. BEGIN TRANSACTION (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä)                          ‚îÇ
‚îÇ    - txId = UUID.randomUUID()                               ‚îÇ
‚îÇ    - INSERT INTO transaction_log (state=PREPARING)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. PREPARE MinIO (participant 1)                            ‚îÇ
‚îÇ    - PUT staging/{txId}.json                                ‚îÇ
‚îÇ    - UPDATE transaction_log: staging_object_key             ‚îÇ
‚îÇ    - –ï—Å–ª–∏ OK ‚Üí vote: COMMIT                                 ‚îÇ
‚îÇ    - –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Üí state = ABORTED, vote: ABORT             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. PREPARE Database (participant 2)                         ‚îÇ
‚îÇ    - –ü–∞—Ä—Å–∏—Ç—å –∏ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å JSON                            ‚îÇ
‚îÇ    - –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –ë–î! –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞                     ‚îÇ
‚îÇ    - UPDATE transaction_log: state = PREPARED               ‚îÇ
‚îÇ    - –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Üí state = ABORTED                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. COORDINATOR DECISION                                      ‚îÇ
‚îÇ    - –ï—Å–ª–∏ –æ–±–∞ PREPARED ‚Üí —Ä–µ—à–µ–Ω–∏–µ = COMMIT                   ‚îÇ
‚îÇ    - –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω ABORTED ‚Üí —Ä–µ—à–µ–Ω–∏–µ = ABORT            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### PHASE 2a: COMMIT (—É—Å–ø–µ—à–Ω—ã–π –ø—É—Ç—å)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. COMMIT Database                                           ‚îÇ
‚îÇ    - UPDATE transaction_log: state = COMMITTING             ‚îÇ
‚îÇ    - –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ (INSERT/UPDATE/DELETE)              ‚îÇ
‚îÇ    - INSERT INTO import_history                             ‚îÇ
‚îÇ    - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ë–î –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. COMMIT MinIO                                              ‚îÇ
‚îÇ    - COPY staging/{txId}.json ‚Üí final/{txId}.json           ‚îÇ
‚îÇ    - DELETE staging/{txId}.json                             ‚îÇ
‚îÇ    - UPDATE transaction_log: state = COMMITTED              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
                    ‚úÖ –£–°–ü–ï–®–ù–û!
```

### PHASE 2b: ABORT (–æ—Ç–∫–∞—Ç)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. ABORT (–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è)                                      ‚îÇ
‚îÇ    - UPDATE transaction_log: state = ABORTING               ‚îÇ
‚îÇ    - DELETE staging/{txId}.json                             ‚îÇ
‚îÇ    - ROLLBACK —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î (@Transactional)                ‚îÇ
‚îÇ    - UPDATE transaction_log: state = ABORTED                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
                    ‚ùå –û–¢–ö–ê–ß–ï–ù–û
```

---

## –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π: –£—Å–ø–µ—à–Ω—ã–π –∏–º–ø–æ—Ä—Ç 1 –∫–≤–∞—Ä—Ç–∏—Ä—ã —Å –¥–æ–º–æ–º

**HTTP Request:**
```http
POST /api/import HTTP/1.1
Content-Type: application/json

[
  {
    "type": "FLAT",
    "operation": "CREATE",
    "data": {
      "name": "–ö–≤–∞—Ä—Ç–∏—Ä–∞ 101",
      "floor": 1,
      "area": 50,
      "price": 5000000,
      "coordinates": {"x": 100, "y": 200},
      "house": {
        "name": "–î–æ–º –Ω–∞ –ù–µ–≤—Å–∫–æ–º",
        "year": 2020,
        "numberOfFlatsOnFloor": 4
      }
    }
  }
]
```

### –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
–í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å | –î–µ–π—Å—Ç–≤–∏–µ
------|--------|----------
t0    | -      | HTTP POST /api/import
t1    | PREPARING | TransactionCoordinator.beginTransaction()
      |        | - txId = a3f7b2c9-...
      |        | - INSERT INTO transaction_log (state=PREPARING)
t2    | PREPARING | TransactionCoordinator.prepareMinIO()
      |        | - Upload to staging/a3f7b2c9-...json
t3    | PREPARED | - MinIO vote: COMMIT ‚úÖ
      |        | - UPDATE transaction_log SET state=PREPARED
t4    | PREPARED | TransactionCoordinator.prepareDatabase()
      |        | - Parse JSON ‚úÖ
      |        | - Validate structure ‚úÖ
      |        | - Database vote: COMMIT ‚úÖ
t5    | PREPARED | Coordinator Decision: COMMIT
t6    | COMMITTING | ImportService: –Ω–∞—á–∞–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
      |        | - UPDATE transaction_log SET state=COMMITTING
t7    | COMMITTING | - CREATE Coordinates (id=150)
t8    | COMMITTING | - CREATE House (id=100)
t9    | COMMITTING | - Validate business rules ‚úÖ
t10   | COMMITTING | - CREATE Flat (id=201)
t11   | COMMITTING | - CREATE ImportHistory (id=123)
      |        | - UPDATE transaction_log SET import_history_id=123
t12   | COMMITTING | TransactionCoordinator.commit()
      |        | - COPY staging ‚Üí final
t13   | COMMITTING | - DELETE staging file
t14   | COMMITTED ‚úÖ| - UPDATE transaction_log SET state=COMMITTED
      |        | - UPDATE import_history SET file_object_key=final/...
t15   | COMMITTED ‚úÖ| HTTP 200 OK
      |        | {"id": 123, "objectsCount": 3}
```

**–û–±—â–µ–µ –≤—Ä–µ–º—è**: ~800ms

---

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ù–µ—É—Å–ø–µ—à–Ω—ã–π –∏–º–ø–æ—Ä—Ç (–Ω–∞—Ä—É—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞)

**HTTP Request** (—Ç–æ—Ç –∂–µ, –Ω–æ –¥–æ–º —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω):

### –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
–í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å | –î–µ–π—Å—Ç–≤–∏–µ
------|--------|----------
t0    | -      | HTTP POST /api/import
t1-t5 | PREPARING‚ÜíPREPARED | (—Ç–æ –∂–µ —Å–∞–º–æ–µ, —á—Ç–æ –≤ —É—Å–ø–µ—à–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏)
t6    | COMMITTING | ImportService: –Ω–∞—á–∞–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
t7    | COMMITTING | - CREATE Coordinates (id=151)
t8    | COMMITTING | - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π House (id=100)
t9    | COMMITTING | FlatService.validateCoordinatesAndFloorUniqueness()
      |        | - HouseRepository.findByIdWithLock(100) üîí
      |        | - COUNT = 4 (—É–∂–µ –µ—Å—Ç—å 4 –∫–≤–∞—Ä—Ç–∏—Ä—ã)
      |        | - 4 + 1 > 4? –î–ê! ‚ùå
t10   | COMMITTING | throw UniqueConstraintViolationException
t11   | ABORTING | TransactionCoordinator.abort()
      |        | - UPDATE transaction_log SET state=ABORTING
t12   | ABORTING | - DELETE staging/a3f7b2c9-...json
t13   | ABORTING | - ROLLBACK database transaction
      |        |   (Coordinates id=151 —É–¥–∞–ª–µ–Ω, House –Ω–µ –∏–∑–º–µ–Ω–µ–Ω)
t14   | ABORTED ‚ùå | - UPDATE transaction_log SET state=ABORTED
t15   | ABORTED ‚ùå | HTTP 400 Bad Request
      |        | {"message": "–ù–∞—Ä—É—à–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏..."}
```

**–û–±—â–µ–µ –≤—Ä–µ–º—è**: ~400ms (–±—ã—Å—Ç—Ä–µ–µ, —Ç.–∫. –Ω–µ –±—ã–ª–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–º–º–∏—Ç–∞)

**HTTP Response:**
```json
{
  "message": "–ù–∞—Ä—É—à–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏: –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö (1, 2) –∏ —ç—Ç–∞–∂–µ 1 —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç 4 –∫–≤–∞—Ä—Ç–∏—Ä(—ã). –ú–∞–∫—Å–∏–º—É–º –¥–ª—è —ç—Ç–æ–≥–æ –¥–æ–º–∞: 4 –∫–≤–∞—Ä—Ç–∏—Ä –Ω–∞ —ç—Ç–∞–∂–µ.",
  "timestamp": "2025-12-22T12:38:50"
}
```

---

## –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

### –ü—Ä–æ–±–ª–µ–º–∞: —á—Ç–æ –µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è?

```java
// –ü—Ä–∏–º–µ—Ä: –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª –∑–∞–ø—Ä–æ—Å –¥–≤–∞–∂–¥—ã
POST /import {same file}  // 1-–π —Ä–∞–∑
POST /import {same file}  // 2-–π —Ä–∞–∑ (retry)
```

### –†–µ—à–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

```java
// 1. –í—ã—á–∏—Å–ª–∏—Ç—å —Ö—ç—à —Ñ–∞–π–ª–∞
String fileHash = SHA256(fileContent);

// 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ —É–∂–µ COMMITTED —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å —Ç–∞–∫–∏–º —Ö—ç—à–æ–º
TransactionLog existing = findByFileHashAndState(fileHash, COMMITTED);
if (existing != null) {
    // –í–µ—Ä–Ω—É—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ImportHistory
    return importHistoryRepository.findById(existing.getImportHistoryId());
}

// 3. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å 2PC...
```

## Recovery –º–µ—Ö–∞–Ω–∏–∑–º

### –ó–∞–≤–∏—Å—à–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (timeout)

**Scheduled job** (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç):

```java
@Schedule(minute = "*/5")
public void recoverTimedOutTransactions() {
    List<TransactionLog> timedOut = findTimedOutTransactions();
    
    for (TransactionLog tx : timedOut) {
        switch (tx.getState()) {
            case PREPARING:
            case PREPARED:
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å (–¥–∞–Ω–Ω—ã—Ö –≤ –ë–î –µ—â–µ –Ω–µ—Ç)
                abort(tx);
                break;
                
            case COMMITTING:
                // –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–æ–º–º–∏—Ç
                retryCommit(tx);
                break;
                
            case ABORTING:
                // –ó–∞–≤–µ—Ä—à–∏—Ç—å –æ—Ç–∫–∞—Ç
                retryAbort(tx);
                break;
        }
    }
}
```

### –û—á–∏—Å—Ç–∫–∞ staging –æ–±–ª–∞—Å—Ç–∏

**Scheduled job** (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00):

```java
@Schedule(hour = "3")
public void cleanupStagingFiles() {
    // –ù–∞–π—Ç–∏ –≤—Å–µ —Ñ–∞–π–ª—ã –≤ staging/ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
    List<String> oldFiles = minioService.listOldStagingFiles(24);
    
    for (String objectKey : oldFiles) {
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ—Ç –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        TransactionLog tx = findByStagingObjectKey(objectKey);
        if (tx == null || tx.getState() == ABORTED) {
            // –£–¥–∞–ª–∏—Ç—å –æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–π —Ñ–∞–π–ª
            minioService.deleteFile(objectKey);
        }
    }
}
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤

```
service/
‚îú‚îÄ‚îÄ ImportService.java              # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –∏–º–ø–æ—Ä—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç 2PC)
‚îú‚îÄ‚îÄ TransactionCoordinator.java     # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä 2PC
‚îú‚îÄ‚îÄ TransactionRecoveryService.java # Recovery –∑–∞–≤–∏—Å—à–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
‚îî‚îÄ‚îÄ MinioService.java              # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å MinIO (staging/final)

entity/
‚îî‚îÄ‚îÄ TransactionLog.java            # –ñ—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

repository/
‚îî‚îÄ‚îÄ TransactionLogRepository.java  # CRUD –¥–ª—è transaction_log
```

## –°—Ü–µ–Ω–∞—Ä–∏–∏ –æ—Ç–∫–∞–∑–æ–≤

### 1. –ü–∞–¥–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ—Å–ª–µ PREPARE MinIO

```
State: staging/{txId}.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, state=PREPARED
Recovery: 
  - Timeout –∏—Å—Ç–µ–∫ -> ABORT
  - –£–¥–∞–ª–∏—Ç—å staging/{txId}.json
  - state = ABORTED
```

### 2. –ü–∞–¥–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ—Å–ª–µ COMMIT Database, –¥–æ COMMIT MinIO

```
State: 
  - –ë–î: ImportHistory —Å–æ–∑–¥–∞–Ω, state=COMMITTING
  - MinIO: staging/{txId}.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, final/ –ø—É—Å—Ç–æ
Recovery:
  - –ù–∞–π—Ç–∏ COMMITTING —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  - –ó–∞–≤–µ—Ä—à–∏—Ç—å: COPY staging -> final, DELETE staging
  - state = COMMITTED
```

### 3. –ü–∞–¥–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è COPY staging -> final

```
State:
  - staging/{txId}.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  - final/{txId}.json –º–æ–∂–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏–ª–∏ –Ω–µ—Ç
Recovery:
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ final/{txId}.json
  - –ï—Å–ª–∏ –¥–∞ -> DELETE staging, state=COMMITTED
  - –ï—Å–ª–∏ –Ω–µ—Ç -> retry COPY, –∑–∞—Ç–µ–º DELETE staging
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

1. ‚úÖ **–ù–∞—Å—Ç–æ—è—â–∞—è —ç–º—É–ª—è—Ü–∏—è 2PC**: staging area –¥–ª—è "–Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö" —Ñ–∞–π–ª–æ–≤
2. ‚úÖ **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã
3. ‚úÖ **Recovery**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å—à–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
4. ‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ (PREPARED/COMMITTED/ABORTED)
5. ‚úÖ **–ê—É–¥–∏—Ç**: –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ transaction_log

## –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ / –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. ‚ùå **–ù–µ –∞—Ç–æ–º–∞—Ä–Ω–æ**: –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏ –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
2. ‚ùå **COPY –≤ MinIO –¥–æ—Ä–æ–≥–æ**: –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ staging -> final
3. ‚ö†Ô∏è **–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –±–æ–ª—å—à–µ –∫–æ–¥–∞, –±–æ–ª—å—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã COPY ‚Üí DELETE

### –í–∞—Ä–∏–∞–Ω—Ç 1: Metadata —Ç—ç–≥–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```java
// PREPARE
minioClient.putObject(bucket, objectKey, data, 
    metadata: {"status": "pending", "txId": txId});

// COMMIT
minioClient.setObjectMetadata(bucket, objectKey,
    metadata: {"status": "committed"});
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**: –Ω–µ –Ω—É–∂–µ–Ω COPY (–±—ã—Å—Ç—Ä–µ–µ, –¥–µ—à–µ–≤–ª–µ)

### –í–∞—Ä–∏–∞–Ω—Ç 2: –î–≤–∞ –±–∞–∫–µ—Ç–∞

```
import-files-staging/   # PREPARE
import-files-final/     # COMMIT
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**: —á–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ, –ª–µ–≥–∫–æ –æ—á–∏—â–∞—Ç—å staging

---

## –†–µ–∑—é–º–µ

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ 2PC –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- ‚úÖ **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å**: –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–∏–±–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é, –ª–∏–±–æ –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è
- ‚úÖ **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å**: PostgreSQL –∏ MinIO –≤—Å–µ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è**: –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç race conditions
- ‚úÖ **–î–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å**: –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ transaction_log
- ‚úÖ **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã –±–ª–∞–≥–æ–¥–∞—Ä—è —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—é
- ‚úÖ **–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º–æ—Å—Ç—å**: recovery –º–µ—Ö–∞–Ω–∏–∑–º –∑–∞–≤–µ—Ä—à–∞–µ—Ç –∑–∞–≤–∏—Å—à–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–°—Ç–∞—Ç—É—Å—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:**
```
PREPARING ‚Üí PREPARED ‚Üí COMMITTING ‚Üí COMMITTED ‚úÖ (—É—Å–ø–µ—Ö)
         ‚Üò ABORTING ‚Üí ABORTED ‚ùå (–æ—à–∏–±–∫–∞)
```

**–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∏–º–ø–æ—Ä—Ç–∞:** ~800-1200ms  
**–¶–∏–∫–ª –æ—Ç–∫–∞—Ç–∞:** ~200-400ms



# Ограничения уникальности

## Реализованное ограничение

**Не может быть больше половины квартир с видом TERRIBLE на одном этаже в доме.**

### Описание

На каждом этаже дома не может быть больше половины квартир с ужасным видом из окна (View.TERRIBLE). Количество квартир на этаже определяется полем `numberOfFlatsOnFloor` в сущности `House`.

### Формула

```
Количество квартир с TERRIBLE на этаже ≤ numberOfFlatsOnFloor / 2
```

### Примеры

1. **Дом с 4 квартирами на этаже:**
   - Максимум 2 квартиры могут иметь вид TERRIBLE
   - Попытка создать 3-ю квартиру с TERRIBLE приведет к ошибке 409 Conflict

2. **Дом с 5 квартирами на этаже:**
   - Максимум 2.5 (округление вниз → 2) квартиры могут иметь вид TERRIBLE
   - Попытка создать 3-ю квартиру с TERRIBLE приведет к ошибке 409 Conflict

3. **Дом с 6 квартирами на этаже:**
   - Максимум 3 квартиры могут иметь вид TERRIBLE
   - Попытка создать 4-ю квартиру с TERRIBLE приведет к ошибке 409 Conflict

### Реализация

Проверка ограничения реализована на уровне бизнес-логики в классе `UniqueConstraintsService`.

#### Компоненты

1. **UniqueConstraintsService** - сервис для проверки ограничений
   - Метод `validateTerribleViewConstraint(Flat flat)` выполняет проверку
   - Выполняет SQL запрос для подсчета квартир с TERRIBLE на этаже
   - Сравнивает результат с допустимым лимитом

2. **UniqueConstraintViolationException** - исключение при нарушении ограничения
   - Выбрасывается при попытке создать/обновить квартиру, нарушающую ограничение

3. **UniqueConstraintViolationExceptionMapper** - обработчик исключения
   - Преобразует исключение в HTTP ответ 409 Conflict
   - Возвращает понятное сообщение об ошибке

#### Интеграция

Проверка выполняется в следующих местах:

1. **FlatService.createFlat()** - при создании новой квартиры
2. **FlatService.updateFlat()** - при обновлении квартиры
3. **ImportService.createFlat()** - при импорте новых квартир
4. **ImportService.updateFlat()** - при импорте обновлений квартир

### Пример ответа при нарушении

**HTTP 409 Conflict**

```json
{
  "message": "Нарушено ограничение уникальности: на этаже 2 дома (ID=5) не может быть больше 2 квартир с видом TERRIBLE. Сейчас: 2, попытка добавить еще одну.",
  "timestamp": "2025-12-07T15:30:00Z"
}
```

### Транзакционность

Проверка ограничения выполняется внутри транзакции:
- При нарушении ограничения транзакция откатывается
- Никаких изменений в базу данных не вносится
- Это гарантирует целостность данных при импорте нескольких объектов

### Уровень изоляции

Для корректной работы ограничения при конкурентном доступе рекомендуется использовать уровень изоляции транзакций **SERIALIZABLE** для операций создания и обновления квартир.

## Тестирование

### Тестовый сценарий 1: Успешное создание

1. Создать дом с `numberOfFlatsOnFloor = 4`
2. Создать 2 квартиры на этаже 1 с видом TERRIBLE
3. ✅ Успех - ограничение не нарушено

### Тестовый сценарий 2: Нарушение ограничения

1. Создать дом с `numberOfFlatsOnFloor = 4`
2. Создать 2 квартиры на этаже 1 с видом TERRIBLE
3. Попытаться создать 3-ю квартиру на этаже 1 с видом TERRIBLE
4. ❌ Ошибка 409 Conflict - ограничение нарушено

### Тестовый сценарий 3: Обновление квартиры

1. Создать дом с `numberOfFlatsOnFloor = 4`
2. Создать 2 квартиры на этаже 1 с видом TERRIBLE
3. Создать еще одну квартиру на этаже 1 с видом GOOD
4. Попытаться обновить последнюю квартиру, изменив вид на TERRIBLE
5. ❌ Ошибка 409 Conflict - ограничение нарушено

### Тестовый сценарий 4: Разные этажи

1. Создать дом с `numberOfFlatsOnFloor = 4`
2. Создать 2 квартиры на этаже 1 с видом TERRIBLE
3. Создать 2 квартиры на этаже 2 с видом TERRIBLE
4. ✅ Успех - ограничение проверяется отдельно для каждого этажа

